# 🏗️ Архитектура Smart Shop

## Схема подключения

```
┌─────────────────────────────────────────────────────────────────┐
│                       ME NETWORK                                 │
│  ┌────────────┐    ┌──────────────┐    ┌─────────────────┐     │
│  │ ME Storage │────│ ME Interface │────│ ME Controller   │     │
│  └────────────┘    └──────────────┘    └────────┬────────┘     │
│                           │                      │              │
│                    ┌──────┴──────┐              │              │
│                    │ Molecular   │              │              │
│                    │ Assembler   │              │              │
│                    └─────────────┘              │              │
└─────────────────────────────────────────────────┼──────────────┘
                                                   │
                                            ┌──────▼──────┐
                                            │   Adapter   │
                                            └──────┬──────┘
                                                   │
┌──────────────────────────────────────────────────┼──────────────┐
│                    OPENCOMPUTERS                 │              │
│                                           ┌──────▼──────┐       │
│  ┌─────────────┐                          │             │       │
│  │   Screen    │◄─────────────────────────┤  Computer   │       │
│  │   (Tier 2+) │                          │  (Case T2+) │       │
│  └─────────────┘                          │             │       │
│                                            │  • CPU      │       │
│  ┌─────────────┐                          │  • RAM x2   │       │
│  │  Keyboard   │◄─────────────────────────┤  • HDD      │       │
│  └─────────────┘                          │  • GPU      │       │
│                                            └──┬─────┬────┘       │
│                                               │     │            │
│                                     ┌─────────┘     └─────────┐  │
│                                     │                         │  │
│                              ┌──────▼──────┐         ┌────────▼─┐│
│                              │ Transposer  │         │Transposer││
│                              │     #1      │         │    #2    ││
│                              └──────┬──────┘         └────┬─────┘│
└─────────────────────────────────────┼───────────────────────┼────┘
                                      │                       │
                                ┌─────▼──────┐         ┌──────▼────┐
                                │   Chest    │         │   Chest   │
                                │  (Деньги)  │         │ (Выдача)  │
                                └────────────┘         └───────────┘
                                      ▲                       ▲
                                      │                       │
                              ┌───────┴───────┐       ┌───────┴───────┐
                              │ Игрок кладет  │       │ Игрок забирает│
                              │     деньги    │       │   предметы    │
                              └───────────────┘       └───────────────┘
```

---

## Поток данных

### 📥 Пополнение баланса

```
┌─────────┐     ┌──────────────┐     ┌──────────────┐     ┌─────────┐
│ Игрок   │────▶│ Сундук денег │────▶│ Transposer#1 │────▶│   ME    │
│ кладет  │     │   (Chest)    │     │   (сканирует,│     │ System  │
│ деньги  │     │              │     │   переносит) │     │         │
└─────────┘     └──────────────┘     └──────────────┘     └─────────┘
                                            │
                                            ▼
                                    ┌──────────────┐
                                    │  Computer    │
                                    │  обновляет   │
                                    │  баланс      │
                                    └──────────────┘
```

### 🛒 Покупка предмета

```
┌─────────┐     ┌──────────────┐     ┌──────────────┐     ┌─────────┐
│ Игрок   │────▶│  Computer    │────▶│     ME       │────▶│Molecular│
│ выбирает│     │  принимает   │     │  Controller  │     │Assembler│
│ предмет │     │  заказ       │     │  (крафт)     │     │         │
└─────────┘     └──────────────┘     └──────────────┘     └────┬────┘
                        │                                       │
                        │                                       ▼
                        │                              ┌──────────────┐
                        │                              │ ME Interface │
                        │                              │  (экспорт)   │
                        │                              └──────┬───────┘
                        │                                     │
                        │            ┌────────────────────────┘
                        │            │
                        │            ▼
                        │    ┌──────────────┐
                        ├───▶│ Transposer#2 │
                        │    │  (перенос в) │
                        │    └──────┬───────┘
                        │           │
                        │           ▼
                        │    ┌──────────────┐
                        │    │Сундук выдачи │
                        │    │   (Chest)    │
                        │    └──────┬───────┘
                        │           │
                        │           ▼
                        │    ┌──────────────┐
                        └───▶│ Баланс -= $  │
                             │ Сообщение ✓  │
                             └──────────────┘
```

---

## Логика программы

### Основной цикл

```
┌─────────────────────────────────────────────────────┐
│                  main()                              │
└────────────────┬────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────┐
│           initComponents()                           │
│  • Поиск ME Controller                              │
│  • Поиск Transposer'ов                              │
│  • Настройка GPU                                     │
│  • Проверка подключений                             │
└────────────────┬────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────┐
│           shopMenu() - главный цикл                  │
└────────────────┬────────────────────────────────────┘
                 │
                 ├──▶ [Событие: Нажата D]
                 │    └──▶ depositMoney()
                 │         ├──▶ countMoneyInChest()
                 │         └──▶ transferMoneyToME()
                 │
                 ├──▶ [Событие: Нажата R]
                 │    └──▶ getItemsFromME()
                 │         ├──▶ me.getItemsInNetwork()
                 │         ├──▶ getDetailedItemInfo()
                 │         └──▶ parsePrice()
                 │
                 ├──▶ [Событие: Ввод текста]
                 │    └──▶ searchItems()
                 │         └──▶ Умный поиск с приоритетами
                 │
                 ├──▶ [Событие: Нажата Enter]
                 │    └──▶ craftAndTransferItem()
                 │         ├──▶ me.getCraftables()
                 │         ├──▶ craftable.request()
                 │         └──▶ me.exportItem()
                 │
                 └──▶ [Событие: ESC] → Выход
```

---

## Парсинг цены (детально)

```
getDetailedItemInfo(itemStack)
         │
         ▼
┌─────────────────────┐
│ hasTag == true?     │
└──────┬──────────────┘
       │ Да
       ▼
┌─────────────────────┐
│ tag.display.Lore?   │
└──────┬──────────────┘
       │ Да
       ▼
┌─────────────────────────────────────────┐
│         parsePrice(lore)                 │
├─────────────────────────────────────────┤
│                                          │
│ Попытка 1:                               │
│  "Минимальная цена: 15.0$"              │
│   ├─ Найдено? → return 15.0             │
│   └─ Нет ↓                               │
│                                          │
│ Попытка 2:                               │
│  "Цена: 15.0$" или "Price: 15.0$"       │
│   ├─ Найдено? → return 15.0             │
│   └─ Нет ↓                               │
│                                          │
│ Попытка 3:                               │
│  "15.0$" или "$15.0"                    │
│   ├─ Найдено? → return 15.0             │
│   └─ Нет ↓                               │
│                                          │
│ Попытка 4:                               │
│  "15.0" (любое дробное)                 │
│   ├─ Найдено? → return 15.0             │
│   └─ Нет ↓                               │
│                                          │
│ return nil                               │
└─────────────────────────────────────────┘
         │
         ▼
┌─────────────────────┐
│ price == nil?       │
│  Да → price = 10.0  │
│  Нет → OK           │
└─────────────────────┘
```

---

## Умный поиск (алгоритм)

```
searchItems(query, items)
         │
         ▼
┌─────────────────────────────────────────┐
│  query = "" ?                            │
│   Да → return all items                  │
│   Нет ↓                                  │
└─────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│  Для каждого предмета:                   │
│                                          │
│  ┌────────────────────────────────────┐ │
│  │ 1. Точное совпадение?              │ │
│  │    label == query                  │ │
│  │    → add to exactMatches           │ │
│  └────────────────────────────────────┘ │
│           │ Нет                          │
│  ┌────────▼───────────────────────────┐ │
│  │ 2. Начинается с?                   │ │
│  │    label.startsWith(query)         │ │
│  │    → add to startMatches           │ │
│  └────────────────────────────────────┘ │
│           │ Нет                          │
│  ┌────────▼───────────────────────────┐ │
│  │ 3. Содержит?                       │ │
│  │    label.contains(query)           │ │
│  │    → add to containsMatches        │ │
│  └────────────────────────────────────┘ │
│           │ Нет                          │
│  ┌────────▼───────────────────────────┐ │
│  │ 4. Все слова найдены?              │ │
│  │    split query → words             │ │
│  │    all words in label?             │ │
│  │    → add to wordMatches            │ │
│  └────────────────────────────────────┘ │
└─────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────┐
│  Объединение результатов:                │
│  1. exactMatches (высший приоритет)      │
│  2. startMatches                         │
│  3. containsMatches                      │
│  4. wordMatches                          │
│                                          │
│  return results                          │
└─────────────────────────────────────────┘
```

---

## Состояния системы

```
       ┌──────────────┐
       │   START      │
       └──────┬───────┘
              │
              ▼
       ┌──────────────┐
       │INIT_COMPONENTS│────▶ [Ошибка] ──▶ EXIT
       └──────┬───────┘
              │ [Успех]
              ▼
       ┌──────────────┐
    ┌─▶│  SHOP_MENU   │◀─────────────┐
    │  └──────┬───────┘               │
    │         │                       │
    │         ├──▶[D]──▶ DEPOSIT ─────┘
    │         │           │
    │         │           └──▶[Успех/Ошибка]
    │         │
    │         ├──▶[R]──▶ REFRESH ─────┘
    │         │           │
    │         │           └──▶[Загружено]
    │         │
    │         ├──▶[Ввод]─▶ SEARCH ────┘
    │         │             │
    │         │             └──▶[Отфильтровано]
    │         │
    │         ├──▶[Enter]─▶ PURCHASE ─┘
    │         │              │
    │         │              └──▶[Куплено/Ошибка]
    │         │
    │         └──▶[ESC]──▶ EXIT
    │
    └─────────────────────────┘
```

---

## Структура данных

### Item Object
```lua
{
    name = "minecraft:diamond",      -- ID предмета
    label = "Алмаз",                 -- Отображаемое имя
    size = 64,                       -- Количество в ME
    damage = 0,                      -- Metadata/Damage
    price = 100.0,                   -- Цена (распознанная или дефолт)
    hasTag = true,                   -- Есть ли NBT
    lore = {                         -- Описание
        "§7Редкий камень",
        "§eМинимальная цена: 100.0$"
    },
    maxSize = 64                     -- Макс. размер стака
}
```

### Config Structure
```lua
{
    meController = "12a4b5c6...",    -- Адрес ME контроллера
    moneyChest = "ef7g8h9i...",      -- Адрес transposer денег
    outputChest = "jk0l1m2n...",     -- Адрес transposer выдачи
    
    moneyItem = "contenttweaker:money", -- ID валюты
    moneyName = "Деньги",             -- Имя валюты
    
    colors = {                        -- Цветовая схема
        bg = 0x000000,
        header = 0x4B4B4B,
        primary = 0x2196F3,
        success = 0x4CAF50,
        error = 0xF44336,
        text = 0xFFFFFF,
        secondary = 0xBBBBBB
    }
}
```

---

## Временная диаграмма покупки

```
Игрок          Computer         ME System      Molecular     Transposer
  │                │                │              │              │
  │──[Enter]──────▶│                │              │              │
  │                │                │              │              │
  │                │───[request]───▶│              │              │
  │                │                │              │              │
  │                │                │──[craft]────▶│              │
  │                │                │              │              │
  │                │◀───[done]──────│◀─────────────┤              │
  │                │                │              │              │
  │                │───[export]────▶│              │              │
  │                │                │──────────────┼──[transfer]─▶│
  │                │                │              │              │
  │                │◀──[exported]───│              │              │
  │                │                │              │              │
  │                │─[balance -= $] │              │              │
  │                │                │              │              │
  │◀──[✓Куплено]───│                │              │              │
  │                │                │              │              │
  │──[забирает предмет из сундука]────────────────────────────────│
  │                                                                │
```

Типичное время: 2-5 секунд в зависимости от сложности крафта

---

## Компонентная архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                      PRESENTATION LAYER                      │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │ drawHeader │  │drawBalance │  │drawItemList│            │
│  └────────────┘  └────────────┘  └────────────┘            │
│         │               │               │                   │
└─────────┼───────────────┼───────────────┼───────────────────┘
          │               │               │
┌─────────┼───────────────┼───────────────┼───────────────────┐
│         │   BUSINESS LOGIC LAYER        │                   │
│         │               │               │                   │
│  ┌──────▼──────┐ ┌──────▼───────┐ ┌────▼───────┐          │
│  │  shopMenu   │ │ depositMoney │ │searchItems │          │
│  └─────────────┘ └──────────────┘ └────────────┘          │
│         │               │               │                   │
└─────────┼───────────────┼───────────────┼───────────────────┘
          │               │               │
┌─────────┼───────────────┼───────────────┼───────────────────┐
│         │   DATA LAYER  │               │                   │
│         │               │               │                   │
│  ┌──────▼────────┐ ┌────▼──────────┐ ┌─▼────────────┐     │
│  │getItemsFromME │ │transferMoney  │ │ parsePrice   │     │
│  │               │ │ToME           │ │              │     │
│  └───────────────┘ └───────────────┘ └──────────────┘     │
│         │               │               │                   │
└─────────┼───────────────┼───────────────┼───────────────────┘
          │               │               │
┌─────────┼───────────────┼───────────────┼───────────────────┐
│         │   COMPONENT LAYER (OpenComputers API)             │
│         │               │               │                   │
│  ┌──────▼──────┐ ┌──────▼───────┐ ┌────▼───────┐          │
│  │me_controller│ │ transposer   │ │    gpu     │          │
│  └─────────────┘ └──────────────┘ └────────────┘          │
└───────────────────────────────────────────────────────────┘
```

---

Эта архитектура обеспечивает:
- ✅ Модульность
- ✅ Отказоустойчивость
- ✅ Расширяемость
- ✅ Читаемость кода
- ✅ Легкость отладки
